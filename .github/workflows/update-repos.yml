name: Update Recent Repositories

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      trigger:
        description: 'Manual trigger'
        required: false
        default: 'manual'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Update README with recent repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          import re
          import requests
          import sys
          
          token = os.environ.get('GITHUB_TOKEN')
          username = 'mertefekurt'
          
          if not token:
              print("Warning: GITHUB_TOKEN not found, using unauthenticated requests")
              headers = {}
          else:
              headers = {'Authorization': f'Bearer {token}'}
          
          url = f'https://api.github.com/users/{username}/repos?sort=updated&per_page=6&type=all'
          
          try:
              response = requests.get(url, headers=headers, timeout=10)
              response.raise_for_status()
              repos = response.json()
              
              if not repos:
                  print("No repositories found")
                  sys.exit(0)
              
              repo_list = []
              for repo in repos:
                  name = repo.get('name', '')
                  description = repo.get('description', 'No description')
                  repo_url = repo.get('html_url', '')
                  language = repo.get('language', '')
                  language_badge = f" `{language}`" if language else ""
                  repo_list.append(f"- **[{name}]({repo_url})**{language_badge} - {description}")
              
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              pattern = r'<!--START_SECTION:activity-->.*?<!--END_SECTION:activity-->'
              replacement = f'<!--START_SECTION:activity-->\n' + '\n'.join(repo_list) + '\n<!--END_SECTION:activity-->'
              
              new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(new_content)
              
              print(f"✅ Updated README with {len(repo_list)} repositories")
              for repo in repo_list:
                  print(f"  {repo}")
          except requests.exceptions.HTTPError as e:
              print(f"❌ HTTP Error: {e}")
              print(f"Response: {e.response.text}")
              sys.exit(1)
          except Exception as e:
              print(f"❌ Error: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if ! git diff --quiet README.md || ! git diff --cached --quiet README.md; then
            git add README.md
            git commit -m "chore: update recent repositories [skip ci]"
            git push
            echo "✅ Changes pushed successfully"
          else
            echo "ℹ️ No changes to commit"
          fi

